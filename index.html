<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>114å¹´åº¦å…¨åœ‹æ½”ç‰™æ¯”è³½æ¨¡æ“¬æ¸¬é©—</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #e3f2fd; padding: 20px; }
        .game-container { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: #007bff; font-size: 24px; margin-bottom: 20px; }
        .btn-container { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { padding: 14px; font-size: 16px; border: none; border-radius: 8px; background-color: #007bff; color: white; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #0056b3; }
        #score-display { margin-top: 20px; font-weight: bold; color: #28a745; font-size: 20px; }
        input[type="text"] { padding: 12px; width: 85%; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; margin-bottom: 10px; outline: none; }
        #leaderboard { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; display: none; }
        .leaderboard-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 18px; }
        .status-msg { color: #888; font-size: 14px; font-style: italic; }
        .info-tag { color: #e67e22; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="game-container">
    <h1>ğŸ¦· å…¨åœ‹æ½”ç‰™æ¯”è³½æ¨¡æ“¬æ¸¬é©—</h1>
    
    <div id="start-screen">
        <p class="info-tag">ğŸ“… æ¯æ—¥ç©åˆ†æŒ‘æˆ°è³½ (éš¨æ©Ÿ20é¡Œ)</p>
        <p>è«‹è¼¸å…¥æ‚¨çš„åå­—é–‹å§‹æ¸¬é©—ï¼š</p>
        <input type="text" id="player-name-input" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" maxlength="10">
        <div class="btn-container">
            <button onclick="startGame()">é–‹å§‹æ¸¬é©—</button>
        </div>
    </div>

    <div id="quiz-section" style="display: none;">
        <h2 id="question" style="font-size: 20px; line-height: 1.5;">è¼‰å…¥é¡Œåº«ä¸­...</h2>
        <div id="options" class="btn-container"></div>
        <div id="score-display">ç›®å‰å¾—åˆ†ï¼š0</div>
    </div>

    <div id="leaderboard">
        <h2 style="color: #f39c12;">ğŸ† ä»Šæ—¥æ’è¡Œæ¦œ (Top 10)</h2>
        <div id="leaderboard-list">
            <p class="status-msg">æ­£åœ¨è¼‰å…¥æ’å...</p>
        </div>
        <button onclick="location.reload()" style="margin-top: 20px; background-color: #95a5a6;">é‡æ–°æŒ‘æˆ°</button>
    </div>
</div>

<script>
    // --- Supabase é€£ç·šè³‡è¨Š ---
    const SUB_URL = "https://wwbiondznucztprpgpaw.supabase.co";
    const SUB_KEY = "sb_publishable_62FaLOtoNtO9o-Zz05kbkA_VLv2pnWv";

    let quizData = [];
    let currentIdx = 0;
    let score = 0;
    let playerName = "";

    // éš¨æ©Ÿæ‰“äº‚é™£åˆ—
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // æŠ“å–é›²ç«¯é¡Œåº«
    async function fetchQuestions() {
        try {
            const response = await fetch(`${SUB_URL}/rest/v1/questions?select=*`, {
                headers: { "apikey": SUB_KEY, "Authorization": `Bearer ${SUB_KEY}` }
            });
            const allData = await response.json();
            
            // æ ¼å¼è½‰æ›ï¼šå°‡ Excel 1-4 è½‰ç‚ºé›»è…¦ 0-3
            let formattedData = allData.map(item => ({
                q: item.q,
                a: [item.a1, item.a2, item.a3, item.a4],
                correct: parseInt(item.correct) - 1
            }));

            // éš¨æ©ŸæŠ½å– 20 é¡Œ
            quizData = shuffleArray(formattedData).slice(0, 20);
        } catch (e) {
            console.error(e);
            alert("é¡Œåº«é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Supabase è¨­å®šã€‚");
        }
    }

    async function startGame() {
        const input = document.getElementById('player-name-input');
        if (!input.value.trim()) return alert("è«‹è¼¸å…¥åå­—ï¼");
        playerName = input.value;
        
        await fetchQuestions();
        if (quizData.length === 0) return alert("é¡Œåº«æ²’è³‡æ–™ï¼");

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('quiz-section').style.display = 'block';
        loadQuiz();
    }

    function loadQuiz() {
        const currentData = quizData[currentIdx];
        document.getElementById('question').innerText = `ç¬¬ ${currentIdx + 1} / ${quizData.length} é¡Œï¼š${currentData.q}`;
        const optionsEl = document.getElementById('options');
        optionsEl.innerHTML = '';
        currentData.a.forEach((option, i) => {
            const btn = document.createElement('button');
            btn.innerText = option;
            btn.onclick = () => checkAnswer(i);
            optionsEl.appendChild(btn);
        });
    }

    function checkAnswer(selected) {
        if (selected === quizData[currentIdx].correct) {
            score += 5;
            alert("âœ… ç­”å°äº†ï¼");
        } else {
            const correctText = quizData[currentIdx].a[quizData[currentIdx].correct];
            alert(`âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctText}`);
        }
        currentIdx++;
        if (currentIdx < quizData.length) {
            loadQuiz();
        } else {
            finishGame();
        }
        document.getElementById('score-display').innerText = `ç›®å‰å¾—åˆ†ï¼š${score}`;
    }

    async function finishGame() {
        document.getElementById('quiz-section').style.display = 'none';
        document.getElementById('leaderboard').style.display = 'block';
        document.getElementById('leaderboard-list').innerHTML = '<p class="status-msg">æ­£åœ¨åŒæ­¥é›²ç«¯åˆ†æ•¸ï¼Œè«‹ç¨å€™...</p>';
        
        await uploadScore();
        // å»¶é² 2 ç§’æŠ“å–æ¦œå–®ï¼Œç¢ºä¿è³‡æ–™åº«å·²åŒæ­¥
        setTimeout(getLeaderboard, 2000); 
    }

    async function uploadScore() {
        try {
            await fetch(`${SUB_URL}/rest/v1/scores`, {
                method: "POST",
                headers: { 
                    "apikey": SUB_KEY, 
                    "Authorization": `Bearer ${SUB_KEY}`, 
                    "Content-Type": "application/json",
                    "Prefer": "return=minimal" 
                },
                body: JSON.stringify({ username: playerName, score: score })
            });
        } catch (e) { console.error("ä¸Šå‚³å¤±æ•—:", e); }
    }

    async function getLeaderboard() {
        const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
        try {
            const response = await fetch(`${SUB_URL}/rest/v1/scores?select=username,score&created_at=gte.${dayAgo}&order=score.desc&limit=10`, {
                headers: { "apikey": SUB_KEY, "Authorization": `Bearer ${SUB_KEY}` }
            });
            const data = await response.json();
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = '';
            
            if (!data || data.length === 0) {
                listEl.innerHTML = '<p>ä»Šæ—¥å°šç„¡ç´€éŒ„</p>';
            } else {
                data.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item';
                    div.innerHTML = `<span>ç¬¬ ${index + 1} å: ${item.username}</span><span>${item.score} åˆ†</span>`;
                    listEl.appendChild(div);
                });
            }
        } catch (e) { console.error("æŠ“å–æ¦œå–®å¤±æ•—:", e); }
    }
</script>
</body>
</html>
